---
- name: Build UnixBench from source
  hosts: all
  become: true
  tasks:
    - name: Install build dependencies
      apt:
        name:
          - build-essential
          - libx11-dev
          - libgl1-mesa-dev
          - libxext-dev
          - wget
        state: present
        update_cache: true

    - name: Ensure build workspace exists
      file:
        path: /tmp/unixbench-src
        state: directory
        mode: "0755"

    - name: Download UnixBench tarball
      get_url:
        url: https://github.com/kdlucas/byte-unixbench/archive/refs/tags/v5.1.3.tar.gz
        dest: /tmp/unixbench-src/UnixBench5.1.3.tgz
        mode: "0644"

    - name: Extract UnixBench
      unarchive:
        src: /tmp/unixbench-src/UnixBench5.1.3.tgz
        dest: /tmp/unixbench-src
        remote_src: true

    - name: Build UnixBench
      make:
        chdir: /tmp/unixbench-src/byte-unixbench-5.1.3

    - name: Install UnixBench to /opt/UnixBench
      command: mv /tmp/unixbench-src/byte-unixbench-5.1.3 /opt/UnixBench
      args:
        creates: /opt/UnixBench/Run

    - name: Cleanup build directory
      file:
        path: /tmp/unixbench-src
        state: absent
